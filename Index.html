<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study.Co – Student Wellness Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --card: rgba(255,255,255,0.06);
      --border: rgba(148,163,184,0.22);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #6366f1;
      --accent-soft: rgba(99,102,241,0.18);
      --radius: 16px;
      --shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    /* Light theme overrides */
    [data-theme="light"] {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --card: rgba(15,23,42,0.04);
      --border: rgba(15,23,42,0.12);
      --text: #0f172a;
      --muted: #475569;
      --accent-soft: rgba(99,102,241,0.12);
      --shadow: 0 18px 45px rgba(15,23,42,0.10);
    }

    * { box-sizing: border-box; font-family: 'Inter', system-ui, -apple-system, Segoe UI, sans-serif; }

    body {
      margin: 0;
      background: radial-gradient(900px 500px at 15% 10%, rgba(99,102,241,0.25), transparent 55%),
                  radial-gradient(900px 500px at 90% 30%, rgba(20,184,166,0.18), transparent 55%),
                  linear-gradient(120deg, var(--bg), color-mix(in srgb, var(--bg) 90%, black 10%));
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* ===== Layout ===== */
    .sidebar {
      width: 264px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 26px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: slideIn 520ms cubic-bezier(.2,.9,.2,1);
    }

    @keyframes slideIn {
      from { transform: translateX(-30px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .logo {
      font-size: 1.55rem;
      font-weight: 750;
      letter-spacing: 0.4px;
      color: var(--accent);
      user-select: none;
    }

    .mini {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav button {
      width: 100%;
      background: transparent;
      border: 1px solid transparent;
      color: var(--muted);
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 200ms ease, border-color 200ms ease, transform 120ms ease, color 200ms ease;
    }

    .nav button:hover {
      background: var(--card);
      border-color: var(--border);
      color: var(--text);
      transform: translateY(-1px);
    }

    .nav button.active {
      background: var(--accent-soft);
      border-color: color-mix(in srgb, var(--accent) 40%, var(--border));
      color: var(--text);
    }

    .nav .pill {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--accent) 20%, transparent);
      color: var(--text);
      border: 1px solid color-mix(in srgb, var(--accent) 35%, transparent);
    }

    .sidebar-footer {
      margin-top: auto;
      border-top: 1px solid var(--border);
      padding-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .quick {
      display: flex;
      gap: 10px;
    }

    .chip {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      color: var(--text);
      transition: transform 120ms ease;
    }

    .chip:hover { transform: translateY(-1px); }

    .main {
      flex: 1;
      padding: 34px 34px 70px;
      overflow-y: auto;
      animation: fadeIn 420ms ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .section { display: none; max-width: 1050px; }
    .section.active { display: block; }

    .topbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 18px;
    }

    h1 {
      font-size: 1.85rem;
      font-weight: 650;
      margin: 0;
    }

    .subtitle {
      color: var(--muted);
      margin-top: 6px;
      font-size: 0.95rem;
    }

    .card {
      background: linear-gradient(160deg, color-mix(in srgb, var(--panel) 65%, transparent), var(--card));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: cardPop 420ms cubic-bezier(.2,.9,.2,1);
      margin-top: 14px;
    }

    @keyframes cardPop {
      from { transform: translateY(14px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ===== Shared controls ===== */
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    input, select {
      background: color-mix(in srgb, var(--panel) 70%, transparent);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 12px;
      outline: none;
      transition: border-color 160ms ease, transform 120ms ease;
    }

    input:focus, select:focus {
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }

    .btn {
      background: var(--accent);
      border: 1px solid color-mix(in srgb, var(--accent) 70%, black 10%);
      color: white;
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 120ms ease, filter 160ms ease;
      user-select: none;
    }

    .btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn.danger {
      background: rgba(239,68,68,0.18);
      border-color: rgba(239,68,68,0.35);
      color: color-mix(in srgb, var(--text) 70%, #ef4444);
    }

    .btn.small { padding: 9px 12px; border-radius: 10px; font-size: 0.9rem; }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      right: 22px;
      bottom: 22px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      min-width: 220px;
      box-shadow: var(--shadow);
      transform: translateY(16px);
      opacity: 0;
      pointer-events: none;
      transition: all 260ms ease;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast .t { font-weight: 600; font-size: 0.95rem; }
    .toast .m { color: var(--muted); margin-top: 2px; font-size: 0.85rem; }

    /* ===== Schedule ===== */
    .schedule-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: end;
      margin-bottom: 14px;
    }

    .schedule-controls .field { min-width: 190px; }

    .schedule-grid {
      display: grid;
      gap: 7px;
      border-radius: 14px;
    }

    .time-cell, .day-cell, .head-cell {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      font-size: 0.85rem;
      text-align: center;
    }

    [data-theme="light"] .time-cell,
    [data-theme="light"] .day-cell,
    [data-theme="light"] .head-cell { background: rgba(15,23,42,0.03); }

    .head-cell {
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      font-weight: 600;
    }

    .day-cell {
      text-align: left;
      cursor: text;
      transition: transform 120ms ease, background 180ms ease, border-color 180ms ease;
      min-height: 46px;
      outline: none;
      line-height: 1.25;
      padding: 11px 12px;
      white-space: pre-wrap;
    }

    .day-cell:hover {
      transform: translateY(-1px);
      background: color-mix(in srgb, var(--accent) 8%, transparent);
      border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
    }

    .day-cell:focus {
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent) 50%, var(--border));
    }

    /* ===== Tasks ===== */
    .taskbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .taskbar .left {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      flex: 1;
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter {
      padding: 8px 10px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      font-size: 0.88rem;
      transition: background 160ms ease, transform 120ms ease;
    }

    .filter.active {
      background: var(--accent-soft);
      border-color: color-mix(in srgb, var(--accent) 45%, var(--border));
    }

    .todo-form {
      display: grid;
      grid-template-columns: 1.4fr 0.8fr 0.8fr 0.6fr auto;
      gap: 10px;
      margin-bottom: 14px;
    }

    .todo-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      margin-bottom: 10px;
      animation: slideUp 260ms ease;
    }

    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .todo-title {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .todo-title .mainline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .priority {
      border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
      color: color-mix(in srgb, var(--text) 70%, var(--accent));
    }

    .meta {
      color: var(--muted);
      font-size: 0.85rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* ===== Pomodoro ===== */
    .pomodoro-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: center;
    }

    .timer {
      font-size: clamp(2.8rem, 5vw, 4.3rem);
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .mode {
      text-align: center;
      color: var(--muted);
      margin-top: 6px;
    }

    .timer-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .stat {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }

    .stat .k { color: var(--muted); font-size: 0.85rem; }
    .stat .v { font-size: 1.35rem; font-weight: 650; margin-top: 6px; }

    /* ===== Settings ===== */
    .hint {
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .switch {
      width: 46px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      position: relative;
      cursor: pointer;
      transition: background 200ms ease;
    }

    .knob {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--text);
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left 200ms ease, background 200ms ease;
    }

    .switch.on {
      background: var(--accent-soft);
      border-color: color-mix(in srgb, var(--accent) 40%, var(--border));
    }

    .switch.on .knob { left: 22px; background: color-mix(in srgb, var(--accent) 40%, white); }

    /* Responsive */
    @media (max-width: 1020px) {
      .pomodoro-wrap { grid-template-columns: 1fr; }
      .todo-form { grid-template-columns: 1.2fr 0.8fr 0.8fr 0.7fr auto; }
    }

    @media (max-width: 860px) {
      body { overflow: auto; height: auto; }
      .sidebar { position: sticky; top: 0; width: 100%; z-index: 3; flex-direction: row; align-items: center; }
      .nav { flex-direction: row; flex: 1; overflow: auto; }
      .nav button { white-space: nowrap; }
      .sidebar-footer { display: none; }
      .main { padding: 18px; }
      .todo-form { grid-template-columns: 1fr; }
      .schedule-controls { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">
      <div>
        <div class="logo">Study.Co</div>
        <div class="mini">wellness • focus • flow</div>
      </div>
      <div class="pill" id="todayPill">—</div>
    </div>

    <div class="nav">
      <button class="active" data-section="schedule">Schedule <span class="pill" id="schedPill">edit</span></button>
      <button data-section="todo">Tasks <span class="pill" id="taskPill">0</span></button>
      <button data-section="pomodoro">Pomodoro <span class="pill" id="pomoPill">idle</span></button>
      <button data-section="settings">Settings <span class="pill">custom</span></button>
    </div>

    <div class="sidebar-footer">
      <div class="quick">
        <button class="chip" id="chipStart">▶ Focus</button>
        <button class="chip" id="chipAdd">＋ Task</button>
      </div>
      <div id="sidebarNote">Tip: your data saves automatically.</div>
    </div>
  </aside>

  <main class="main">
    <!-- Schedule -->
    <section id="schedule" class="section active">
      <div class="topbar">
        <div>
          <h1>Custom Schedule</h1>
          <div class="subtitle">Click any cell to type. Everything saves automatically.</div>
        </div>
      </div>

      <div class="card">
        <div class="schedule-controls">
          <div class="field">
            <div class="label">Start hour</div>
            <input id="startHour" type="number" min="0" max="23" />
          </div>
          <div class="field">
            <div class="label">Hours shown</div>
            <input id="hoursShown" type="number" min="1" max="18" />
          </div>
          <div class="field">
            <div class="label">Days</div>
            <select id="dayMode">
              <option value="5">Mon–Fri</option>
              <option value="7">Mon–Sun</option>
            </select>
          </div>
          <button class="btn small" id="applySchedule">Apply</button>
          <button class="btn ghost small" id="addHour">+ Hour</button>
          <button class="btn danger small" id="clearSchedule">Clear schedule</button>
        </div>
        <div class="schedule-grid" id="scheduleGrid"></div>
      </div>
    </section>

    <!-- Tasks -->
    <section id="todo" class="section">
      <div class="topbar">
        <div>
          <h1>Task Manager</h1>
          <div class="subtitle">Add tasks, filter by category, and track what’s next.</div>
        </div>
      </div>

      <div class="card">
        <div class="taskbar">
          <div class="left">
            <div class="filters" id="filters">
              <button class="filter active" data-filter="All">All</button>
              <button class="filter" data-filter="Homework">Homework</button>
              <button class="filter" data-filter="Project">Project</button>
              <button class="filter" data-filter="Misc">Misc</button>
            </div>
            <input id="search" placeholder="Search tasks…" />
          </div>
          <button class="btn small" id="clearDone">Clear all</button>
        </div>

        <div class="todo-form">
          <input id="taskInput" placeholder="What do you need to do?" />
          <select id="category">
            <option>Homework</option>
            <option>Project</option>
            <option>Misc</option>
          </select>
          <select id="priority">
            <option value="Normal">Normal</option>
            <option value="High">High</option>
          </select>
          <input id="due" type="date" />
          <button class="btn" id="addTaskBtn">Add</button>
        </div>

        <div id="todoList"></div>
      </div>
    </section>

    <!-- Pomodoro -->
    <section id="pomodoro" class="section">
      <div class="topbar">
        <div>
          <h1>Pomodoro Focus</h1>
          <div class="subtitle">Work → break cycles with session tracking.</div>
        </div>
      </div>

      <div class="card">
        <div class="pomodoro-wrap">
          <div>
            <div class="timer" id="timer">25:00</div>
            <div class="mode" id="modeLabel">Focus</div>
            <div class="timer-controls">
              <button class="btn" id="startPomo">Start</button>
              <button class="btn ghost" id="pausePomo">Pause</button>
              <button class="btn ghost" id="skipPomo">Skip</button>
              <button class="btn danger" id="resetPomo">Reset</button>
            </div>
          </div>
          <div class="row">
            <div class="stat">
              <div class="k">Sessions completed</div>
              <div class="v" id="sessions">0</div>
            </div>
            <div class="stat">
              <div class="k">Current streak</div>
              <div class="v" id="streak">0</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="section">
      <div class="topbar">
        <div>
          <h1>Settings</h1>
          <div class="subtitle">Customize theme, accent color, and Pomodoro durations.</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="align-items: end;">
          <div class="field">
            <div class="label">Theme</div>
            <div class="toggle">
              <div class="switch" id="themeSwitch" role="switch" aria-checked="false"><div class="knob"></div></div>
              <div class="hint" id="themeText">Dark mode</div>
            </div>
          </div>
          <div class="field">
            <div class="label">Accent color</div>
            <input id="accentPicker" type="color" />
          </div>
        </div>

        <div style="height: 14px"></div>

        <div class="row">
          <div class="field">
            <div class="label">Focus minutes</div>
            <input id="focusMin" type="number" min="1" max="120" />
          </div>
          <div class="field">
            <div class="label">Break minutes</div>
            <input id="breakMin" type="number" min="1" max="60" />
          </div>
        </div>

        <div style="height: 14px"></div>

        <div class="row">
          <button class="btn" id="saveSettings">Save settings</button>
          <button class="btn danger" id="factoryReset">Factory reset (clear all data)</button>
        </div>

        <p class="hint" style="margin-top: 14px">
          Your schedule, tasks, and focus stats are saved locally in your browser using <b>localStorage</b>.
        </p>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">
    <div class="t" id="toastTitle">Saved</div>
    <div class="m" id="toastMsg">Your changes were saved.</div>
  </div>

  <script>
    /* ================= Utilities ================= */
    const $ = (id) => document.getElementById(id);

    function toast(title, msg) {
      $('toastTitle').textContent = title;
      $('toastMsg').textContent = msg;
      const t = $('toast');
      t.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.classList.remove('show'), 2200);
    }

    function fmtTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      if (h <= 0) return `${m}:00`;
      return `${h}:${String(m).padStart(2,'0')}`;
    }

    /* ================= Initial pills ================= */
    const now = new Date();
    $('todayPill').textContent = now.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });

    /* ================= Navigation ================= */
    document.querySelectorAll('.nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.section).classList.add('active');
      });
    });

    /* ================= Settings (theme + accent + pomodoro durations) ================= */
    const settings = {
      theme: localStorage.getItem('theme') || 'dark',
      accent: localStorage.getItem('accent') || '#6366f1',
      focusMin: Number(localStorage.getItem('focusMin') || 25),
      breakMin: Number(localStorage.getItem('breakMin') || 5),
    };

    function applyTheme() {
      document.documentElement.dataset.theme = settings.theme === 'light' ? 'light' : 'dark';
      document.documentElement.style.setProperty('--accent', settings.accent);

      const sw = $('themeSwitch');
      const on = settings.theme === 'light';
      sw.classList.toggle('on', on);
      sw.setAttribute('aria-checked', String(on));
      $('themeText').textContent = on ? 'Light mode' : 'Dark mode';

      $('accentPicker').value = settings.accent;
      $('focusMin').value = settings.focusMin;
      $('breakMin').value = settings.breakMin;
    }

    $('themeSwitch').addEventListener('click', () => {
      settings.theme = (settings.theme === 'dark') ? 'light' : 'dark';
      localStorage.setItem('theme', settings.theme);
      applyTheme();
      toast('Theme updated', `Now using ${settings.theme} mode.`);
    });

    $('accentPicker').addEventListener('input', (e) => {
      settings.accent = e.target.value;
      document.documentElement.style.setProperty('--accent', settings.accent);
    });

    $('saveSettings').addEventListener('click', () => {
      settings.focusMin = Math.max(1, Math.min(120, Number($('focusMin').value || 25)));
      settings.breakMin = Math.max(1, Math.min(60, Number($('breakMin').value || 5)));
      localStorage.setItem('accent', settings.accent);
      localStorage.setItem('focusMin', String(settings.focusMin));
      localStorage.setItem('breakMin', String(settings.breakMin));
      toast('Settings saved', 'Pomodoro durations and theme saved.');
      pomodoro.resetToSettings();
    });

    $('factoryReset').addEventListener('click', () => {
      if (!confirm('This will clear schedule, tasks, and focus stats from this browser. Continue?')) return;
      localStorage.clear();
      location.reload();
    });

    applyTheme();

    /* ================= Schedule ================= */
    const schedule = {
      startHour: Number(localStorage.getItem('startHour') || 8),
      hoursShown: Number(localStorage.getItem('hoursShown') || 8),
      dayMode: Number(localStorage.getItem('dayMode') || 5),
      days: () => (Number(schedule.dayMode) === 7 ? ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] : ['Mon','Tue','Wed','Thu','Fri']),
      keyFor: (r, c) => `sched:${schedule.startHour}:${schedule.hoursShown}:${schedule.dayMode}:${r}:${c}`,
    };

    function renderSchedule() {
      const days = schedule.days();
      const grid = $('scheduleGrid');
      grid.style.gridTemplateColumns = `110px repeat(${days.length}, 1fr)`;
      grid.innerHTML = '';

      // top-left empty
      const corner = document.createElement('div');
      corner.className = 'head-cell';
      corner.textContent = 'Time';
      grid.appendChild(corner);

      // headers
      days.forEach(d => {
        const h = document.createElement('div');
        h.className = 'head-cell';
        h.textContent = d;
        grid.appendChild(h);
      });

      for (let r = 0; r < schedule.hoursShown; r++) {
        const label = document.createElement('div');
        label.className = 'time-cell';
        const hour = (schedule.startHour + r) % 24;
        label.textContent = `${String(hour).padStart(2,'0')}:00`;
        grid.appendChild(label);

        for (let c = 0; c < days.length; c++) {
          const cell = document.createElement('div');
          cell.className = 'day-cell';
          cell.contentEditable = true;
          const k = schedule.keyFor(r, c);
          cell.dataset.key = k;
          cell.textContent = localStorage.getItem(k) || '';
          cell.addEventListener('input', () => {
            localStorage.setItem(k, cell.textContent);
            $('schedPill').textContent = 'saved';
            clearTimeout(renderSchedule._pill);
            renderSchedule._pill = setTimeout(() => $('schedPill').textContent = 'edit', 900);
          });
          grid.appendChild(cell);
        }
      }
    }

    function syncScheduleControls() {
      $('startHour').value = schedule.startHour;
      $('hoursShown').value = schedule.hoursShown;
      $('dayMode').value = String(schedule.dayMode);
    }

    $('applySchedule').addEventListener('click', () => {
      schedule.startHour = Math.max(0, Math.min(23, Number($('startHour').value || 8)));
      schedule.hoursShown = Math.max(1, Math.min(18, Number($('hoursShown').value || 8)));
      schedule.dayMode = Number($('dayMode').value);
      localStorage.setItem('startHour', String(schedule.startHour));
      localStorage.setItem('hoursShown', String(schedule.hoursShown));
      localStorage.setItem('dayMode', String(schedule.dayMode));
      renderSchedule();
      toast('Schedule updated', 'Grid layout applied.');
    });

    $('addHour').addEventListener('click', () => {
      schedule.hoursShown = Math.min(18, schedule.hoursShown + 1);
      localStorage.setItem('hoursShown', String(schedule.hoursShown));
      syncScheduleControls();
      renderSchedule();
      toast('Hour added', `Now showing ${schedule.hoursShown} hours.`);
    });

    $('clearSchedule').addEventListener('click', () => {
      if (!confirm('Clear all schedule cells?')) return;
      const keys = Object.keys(localStorage).filter(k => k.startsWith('sched:'));
      keys.forEach(k => localStorage.removeItem(k));
      renderSchedule();
      toast('Cleared', 'Schedule cleared.');
    });

    syncScheduleControls();
    renderSchedule();

    /* ================= Tasks ================= */
    let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
    let activeFilter = 'All';

    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
      $('taskPill').textContent = String(tasks.length);
    }

    function matchesFilter(t) {
      const q = ($('search').value || '').trim().toLowerCase();
      const textOk = !q || (t.text.toLowerCase().includes(q));
      const catOk = (activeFilter === 'All') || (t.cat === activeFilter);
      return textOk && catOk;
    }

    function renderTasks() {
      const list = $('todoList');
      list.innerHTML = '';

      const visible = tasks.filter(matchesFilter);
      visible.forEach((t, idxVisible) => {
        const idx = tasks.indexOf(t);
        const item = document.createElement('div');
        item.className = 'todo-item';

        const dueTxt = t.due ? new Date(t.due).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) : 'No due date';

        item.innerHTML = `
          <div class="todo-title">
            <div class="mainline">
              <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(t.text)}</div>
              <span class="badge">${escapeHtml(t.cat)}</span>
              ${t.priority === 'High' ? '<span class="badge priority">High</span>' : ''}
            </div>
            <div class="meta">
              <span>Due: ${escapeHtml(dueTxt)}</span>
            </div>
          </div>
          <div class="actions">
            <button class="btn small" data-act="focus" data-idx="${idx}">Focus</button>
            <button class="btn ghost small" data-act="edit" data-idx="${idx}">Edit</button>
            <button class="btn danger small" data-act="done" data-idx="${idx}">Done</button>
          </div>
        `;

        list.appendChild(item);
      });

      $('taskPill').textContent = String(tasks.length);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    $('addTaskBtn').addEventListener('click', () => {
      const text = $('taskInput').value.trim();
      if (!text) return toast('Missing task', 'Type something first.');

      tasks.unshift({
        id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()),
        text,
        cat: $('category').value,
        priority: $('priority').value,
        due: $('due').value || ''
      });

      $('taskInput').value = '';
      $('due').value = '';
      saveTasks();
      renderTasks();
      toast('Task added', 'Added to your list.');
    });

    $('taskInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') $('addTaskBtn').click();
    });

    $('search').addEventListener('input', renderTasks);

    $('filters').addEventListener('click', (e) => {
      const btn = e.target.closest('.filter');
      if (!btn) return;
      document.querySelectorAll('.filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeFilter = btn.dataset.filter;
      renderTasks();
    });

    $('todoList').addEventListener('click', (e) => {
      const b = e.target.closest('button');
      if (!b) return;
      const idx = Number(b.dataset.idx);
      const act = b.dataset.act;
      const t = tasks[idx];
      if (!t) return;

      if (act === 'done') {
        tasks.splice(idx, 1);
        saveTasks();
        renderTasks();
        toast('Completed', 'Nice work ✅');
        return;
      }

      if (act === 'edit') {
        const next = prompt('Edit task text:', t.text);
        if (next === null) return;
        const trimmed = next.trim();
        if (!trimmed) return toast('Not saved', 'Task cannot be empty.');
        t.text = trimmed;
        saveTasks();
        renderTasks();
        toast('Updated', 'Task updated.');
        return;
      }

      if (act === 'focus') {
        // jump to Pomodoro & start
        document.querySelector('[data-section="pomodoro"]').click();
        pomodoro.start();
        toast('Focus started', `Working on: ${t.text}`);
        return;
      }
    });

    $('clearDone').addEventListener('click', () => {
      if (!confirm('Clear ALL tasks?')) return;
      tasks = [];
      saveTasks();
      renderTasks();
      toast('Cleared', 'All tasks removed.');
    });

    saveTasks();
    renderTasks();

    /* ================= Pomodoro (focus/break cycles + streak) ================= */
    const pomodoro = {
      mode: 'focus', // focus | break
      secondsLeft: settings.focusMin * 60,
      running: false,
      interval: null,
      sessions: Number(localStorage.getItem('pomoSessions') || 0),
      streak: Number(localStorage.getItem('pomoStreak') || 0),

      applyUI() {
        $('timer').textContent = pomodoro.format();
        $('modeLabel').textContent = pomodoro.mode === 'focus' ? 'Focus' : 'Break';
        $('sessions').textContent = String(pomodoro.sessions);
        $('streak').textContent = String(pomodoro.streak);
        $('pomoPill').textContent = pomodoro.running ? 'running' : 'idle';
      },

      format() {
        const m = Math.floor(pomodoro.secondsLeft / 60);
        const s = pomodoro.secondsLeft % 60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      },

      tick() {
        if (!pomodoro.running) return;
        if (pomodoro.secondsLeft > 0) {
          pomodoro.secondsLeft--;
          pomodoro.applyUI();
          return;
        }

        // phase complete
        if (pomodoro.mode === 'focus') {
          pomodoro.sessions++;
          pomodoro.streak++;
          localStorage.setItem('pomoSessions', String(pomodoro.sessions));
          localStorage.setItem('pomoStreak', String(pomodoro.streak));
          toast('Focus complete', 'Time for a break.');
          pomodoro.mode = 'break';
          pomodoro.secondsLeft = settings.breakMin * 60;
        } else {
          toast('Break complete', 'Back to focus!');
          pomodoro.mode = 'focus';
          pomodoro.secondsLeft = settings.focusMin * 60;
        }

        pomodoro.applyUI();
      },

      start() {
        if (pomodoro.running) return;
        pomodoro.running = true;
        pomodoro.interval = setInterval(pomodoro.tick, 1000);
        pomodoro.applyUI();
      },

      pause() {
        pomodoro.running = false;
        clearInterval(pomodoro.interval);
        pomodoro.interval = null;
        pomodoro.applyUI();
      },

      skip() {
        // move to next phase
        if (pomodoro.mode === 'focus') {
          pomodoro.mode = 'break';
          pomodoro.secondsLeft = settings.breakMin * 60;
          toast('Skipped', 'Skipping to break.');
        } else {
          pomodoro.mode = 'focus';
          pomodoro.secondsLeft = settings.focusMin * 60;
          toast('Skipped', 'Skipping to focus.');
        }
        pomodoro.applyUI();
      },

      resetToSettings() {
        pomodoro.pause();
        pomodoro.mode = 'focus';
        pomodoro.secondsLeft = settings.focusMin * 60;
        pomodoro.applyUI();
      },

      resetStats() {
        pomodoro.sessions = 0;
        pomodoro.streak = 0;
        localStorage.setItem('pomoSessions', '0');
        localStorage.setItem('pomoStreak', '0');
        pomodoro.applyUI();
      }
    };

    $('startPomo').addEventListener('click', () => pomodoro.start());
    $('pausePomo').addEventListener('click', () => pomodoro.pause());
    $('skipPomo').addEventListener('click', () => pomodoro.skip());
    $('resetPomo').addEventListener('click', () => pomodoro.resetToSettings());

    pomodoro.applyUI();

    /* ================= Sidebar quick actions ================= */
    $('chipStart').addEventListener('click', () => {
      document.querySelector('[data-section="pomodoro"]').click();
      pomodoro.start();
      toast('Focus started', `Mode: ${pomodoro.mode === 'focus' ? 'Focus' : 'Break'}`);
    });

    $('chipAdd').addEventListener('click', () => {
      document.querySelector('[data-section="todo"]').click();
      setTimeout(() => $('taskInput').focus(), 50);
      toast('Add a task', 'Type and press Enter.');
    });

    // A tiny quality-of-life: keep pills accurate on load
    $('taskPill').textContent = String(tasks.length);
    $('pomoPill').textContent = pomodoro.running ? 'running' : 'idle';
  </script>
</body>
</html>
